<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bildredigerare för Flera Bilder</title>
    
    <!-- Ladda in Tailwind CSS för snabb och modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ladda in Lucide Icons för ikoner -->
    <script src="https://unpkg.com/lucide/dist/umd/lucide.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Anpassad styling för applikationen */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .tab.active {
            background-color: #374151; /* gray-700 */
            border-bottom-color: #3b82f6; /* blue-500 */
        }
        #file-input { display: none; }
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        #workspace.cropping, #workspace.lassoing, #workspace.focusing, #workspace.color-selecting { cursor: crosshair; }
        #workspace.pasting { cursor: copy; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .tool-button.active { background-color: #3b82f6; color: white; }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #selected-color-preview {
            width: 100%;
            height: 30px;
            border-radius: 0.25rem;
            border: 2px solid #4b5563;
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col h-screen overflow-hidden">

    <!-- Huvud-header -->
    <header class="bg-gray-800 border-b border-gray-700 p-3 flex items-center justify-between shadow-md z-20">
        <div class="flex items-center gap-3">
            <i data-lucide="image" class="text-blue-400"></i>
            <h1 class="text-xl font-bold text-gray-100">Bildredigerare Pro</h1>
        </div>
        <div>
            <label for="file-input" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm cursor-pointer transition-colors duration-200 flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                Lägg till bilder
            </label>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>
    </header>

    <!-- Huvudlayout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Vänster sidopanel -->
        <aside id="editor-sidebar" class="w-80 bg-gray-800 p-4 flex-shrink-0 flex flex-col gap-6 overflow-y-auto shadow-lg">
            <div id="no-image-selected-message" class="text-center text-gray-400 mt-8">
                <i data-lucide="image-off" class="mx-auto w-16 h-16 text-gray-600"></i>
                <p class="mt-4 font-medium">Ingen bild vald</p>
                <p class="text-sm">Lägg till en bild för att börja redigera.</p>
            </div>

            <div id="tools-container" class="hidden flex-col gap-6">
                 <!-- Verktyg -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2 flex items-center gap-2"><i data-lucide="wand-2" class="w-5 h-5 text-gray-400"></i>Verktyg</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <button id="crop-tool-btn" title="Beskär" class="tool-button bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium p-3 rounded-lg flex items-center justify-center transition-colors duration-200">
                            <i data-lucide="crop" class="w-5 h-5"></i>
                        </button>
                        <button id="focus-tool-btn" title="Fokus" class="tool-button bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium p-3 rounded-lg flex items-center justify-center transition-colors duration-200">
                           <i data-lucide="aperture" class="w-5 h-5"></i>
                        </button>
                        <button id="lasso-tool-btn" title="Lasso" class="tool-button bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium p-3 rounded-lg flex items-center justify-center transition-colors duration-200">
                           <i data-lucide="lasso-select" class="w-5 h-5"></i>
                        </button>
                         <button id="color-select-tool-btn" title="Färgval" class="tool-button bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium p-3 rounded-lg flex items-center justify-center transition-colors duration-200">
                           <i data-lucide="pipette" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <!-- Dynamiska verktygskontroller -->
                    <div id="crop-controls" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-center text-gray-300 mb-2">Dra på bilden för att beskära</p>
                        <div class="grid grid-cols-2 gap-2">
                             <button id="apply-crop-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>Använd
                            </button>
                            <button id="cancel-crop-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="x" class="w-4 h-4"></i>Avbryt
                            </button>
                        </div>
                    </div>
                     <div id="focus-controls" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg space-y-4">
                        <p class="text-sm text-center text-gray-300 mb-2">Rita på bilden för att markera fokus</p>
                        <div>
                            <label for="focus-blur" class="block text-sm font-medium text-gray-300 mb-1">Bakgrundsoskärpa</label>
                            <input type="range" id="focus-blur" min="0" max="20" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div id="focus-actions" class="hidden grid-cols-2 gap-2">
                             <button id="apply-focus-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>Använd
                            </button>
                            <button id="cancel-focus-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="x" class="w-4 h-4"></i>Avbryt
                            </button>
                        </div>
                    </div>
                    <div id="lasso-controls" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-center text-gray-300 mb-2">Markering klar</p>
                        <div class="grid grid-cols-2 gap-2">
                             <button id="copy-lasso-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="copy" class="w-4 h-4"></i>Kopiera
                            </button>
                            <button id="cut-lasso-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="scissors" class="w-4 h-4"></i>Klipp ut
                            </button>
                        </div>
                    </div>
                    <div id="color-select-controls" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg space-y-4">
                        <p class="text-sm text-center text-gray-300 mb-2">Klicka på en färg i bilden</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Vald färg</label>
                            <div id="selected-color-preview"></div>
                        </div>
                        <div>
                            <label for="color-tolerance" class="block text-sm font-medium text-gray-300 mb-1">Tolerans</label>
                            <input type="range" id="color-tolerance" min="0" max="150" value="30" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div id="color-select-actions" class="hidden grid-cols-2 gap-2">
                             <button id="apply-color-select-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>Använd
                            </button>
                            <button id="cancel-color-select-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="x" class="w-4 h-4"></i>Avbryt
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Justeringar -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2 flex items-center gap-2"><i data-lucide="sliders-horizontal" class="w-5 h-5 text-gray-400"></i>Justeringar</h3>
                    <div class="space-y-4">
                        <div class="filter-control">
                            <label for="brightness" class="block text-sm font-medium text-gray-300 mb-1">Ljusstyrka</label>
                            <input type="range" id="brightness" min="-100" max="100" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="filter-control">
                            <label for="contrast" class="block text-sm font-medium text-gray-300 mb-1">Kontrast</label>
                            <input type="range" id="contrast" min="-100" max="100" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="filter-control">
                            <label for="saturate" class="block text-sm font-medium text-gray-300 mb-1">Mättnad</label>
                            <input type="range" id="saturate" min="0" max="200" value="100" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div class="filter-control">
                            <label for="grayscale" class="block text-sm font-medium text-gray-300 mb-1">Gråskala</label>
                            <input type="range" id="grayscale" min="0" max="100" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="filter-control">
                            <label for="sepia" class="block text-sm font-medium text-gray-300 mb-1">Sepia</label>
                            <input type="range" id="sepia" min="0" max="100" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <!-- Åtgärder -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2 flex items-center gap-2"><i data-lucide="settings-2" class="w-5 h-5 text-gray-400"></i>Åtgärder</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="paste-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-colors duration-200" disabled>
                            <i data-lucide="clipboard-paste" class="w-4 h-4"></i>Klistra in
                        </button>
                        <button id="reset-filters-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-colors duration-200">
                            <i data-lucide="rotate-cw" class="w-4 h-4"></i>Återställ
                        </button>
                        <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-colors duration-200 col-span-2">
                            <i data-lucide="download" class="w-4 h-4"></i>Spara Bild
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Huvudinnehåll -->
        <main class="flex-1 flex flex-col bg-gray-900 overflow-hidden">
            <!-- Flik-rad -->
            <div id="tabs-container" class="flex-shrink-0 bg-gray-800 border-b border-gray-700">
                <div id="tabs" class="flex items-center"></div>
            </div>
            
            <!-- Arbetsyta -->
            <div id="workspace" class="flex-1 p-4 bg-gray-900 flex items-center justify-center overflow-auto relative">
                 <div id="welcome-message" class="text-center text-gray-500">
                    <i data-lucide="image-plus" class="mx-auto w-24 h-24 text-gray-700"></i>
                    <h2 class="mt-4 text-2xl font-bold">Välkommen till Bildredigeraren!</h2>
                    <p class="mt-2 text-lg">Klicka på "Lägg till bilder" för att komma igång.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.addEventListener('load', () => {
            lucide.createIcons();

            // DOM-referenser
            const fileInput = document.getElementById('file-input');
            const tabsContainer = document.getElementById('tabs');
            const workspace = document.getElementById('workspace');
            const welcomeMessage = document.getElementById('welcome-message');
            const noImageMessage = document.getElementById('no-image-selected-message');
            const toolsContainer = document.getElementById('tools-container');
            const cropToolBtn = document.getElementById('crop-tool-btn');
            const focusToolBtn = document.getElementById('focus-tool-btn');
            const lassoToolBtn = document.getElementById('lasso-tool-btn');
            const colorSelectToolBtn = document.getElementById('color-select-tool-btn');
            const cropControls = document.getElementById('crop-controls');
            const focusControls = document.getElementById('focus-controls');
            const lassoControls = document.getElementById('lasso-controls');
            const colorSelectControls = document.getElementById('color-select-controls');
            const applyCropBtn = document.getElementById('apply-crop-btn');
            const cancelCropBtn = document.getElementById('cancel-crop-btn');
            const copyLassoBtn = document.getElementById('copy-lasso-btn');
            const cutLassoBtn = document.getElementById('cut-lasso-btn');
            const focusBlurSlider = document.getElementById('focus-blur');
            const focusActions = document.getElementById('focus-actions');
            const applyFocusBtn = document.getElementById('apply-focus-btn');
            const cancelFocusBtn = document.getElementById('cancel-focus-btn');
            const colorToleranceSlider = document.getElementById('color-tolerance');
            const selectedColorPreview = document.getElementById('selected-color-preview');
            const colorSelectActions = document.getElementById('color-select-actions');
            const applyColorSelectBtn = document.getElementById('apply-color-select-btn');
            const cancelColorSelectBtn = document.getElementById('cancel-color-select-btn');
            const pasteBtn = document.getElementById('paste-btn');
            const resetBtn = document.getElementById('reset-filters-btn');
            const downloadBtn = document.getElementById('download-btn');

            // Applikationens tillstånd
            let appState = {
                images: [],
                activeImageId: null,
                activeTool: null, // 'crop', 'focus', 'lasso', 'pasting', 'color-select'
                cropBox: null,
                isCropping: false,
                lassoPath: [],
                isDrawingLasso: false,
                isDrawingFocus: false,
                clipboard: null,
                pastedItem: null,
            };

            // ---- HÄNDELSEHANTERARE ----
            fileInput.addEventListener('change', handleImageUpload);
            
            document.querySelectorAll('.filter-control input').forEach(input => {
                input.addEventListener('input', () => {
                    updateFiltersFromUI();
                    redrawActiveCanvas();
                });
            });

            resetBtn.addEventListener('click', resetActiveImage);
            downloadBtn.addEventListener('click', downloadActiveImage);
            pasteBtn.addEventListener('click', enterPastingMode);

            // Verktygsknappar
            cropToolBtn.addEventListener('click', () => toggleTool('crop'));
            focusToolBtn.addEventListener('click', () => toggleTool('focus'));
            lassoToolBtn.addEventListener('click', () => toggleTool('lasso'));
            colorSelectToolBtn.addEventListener('click', () => toggleTool('color-select'));

            // Verktygskontroller
            applyCropBtn.addEventListener('click', applyCrop);
            cancelCropBtn.addEventListener('click', () => toggleTool('crop'));
            copyLassoBtn.addEventListener('click', () => handleLassoSelection(false));
            cutLassoBtn.addEventListener('click', () => handleLassoSelection(true));
            focusBlurSlider.addEventListener('input', () => redrawActiveCanvas());
            applyFocusBtn.addEventListener('click', applyFocus);
            cancelFocusBtn.addEventListener('click', cancelFocus);
            colorToleranceSlider.addEventListener('input', () => redrawActiveCanvas());
            applyColorSelectBtn.addEventListener('click', applyColorSelect);
            cancelColorSelectBtn.addEventListener('click', cancelColorSelect);
            
            // Arbetsyta
            workspace.addEventListener('mousedown', handleWorkspaceMouseDown);
            workspace.addEventListener('mousemove', handleWorkspaceMouseMove);
            workspace.addEventListener('mouseup', handleWorkspaceMouseUp);
            workspace.addEventListener('click', handleWorkspaceClick);


            // ---- KÄRNFUNKTIONER ----

            function handleImageUpload(e) {
                const files = e.target.files;
                if (files.length > 0) welcomeMessage.classList.add('hidden');
                
                Array.from(files).forEach(file => {
                    if (appState.images.some(img => img.name === file.name)) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const imageId = `img-${Date.now()}-${Math.random()}`;
                            const newImage = {
                                id: imageId, name: file.name, originalElement: img,
                                currentElement: img, filters: getDefaultFilters(),
                                focus: { path: [], blur: 5 }, 
                                colorSelect: { color: null, tolerance: 30 },
                                canvas: null,
                            };
                            appState.images.push(newImage);
                            createCanvasForImage(newImage);
                            switchTab(imageId);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = ''; 
            }
            
            function createCanvasForImage(imageObject) {
                const canvas = document.createElement('canvas');
                canvas.id = `canvas-${imageObject.id}`;
                canvas.classList.add('hidden');
                workspace.appendChild(canvas);
                imageObject.canvas = canvas;
                updateCanvas(imageObject);
            }

            function updateCanvas(imageObject) {
                const img = imageObject.currentElement;
                const canvas = imageObject.canvas;
                canvas.width = img.width;
                canvas.height = img.height;
                redrawCanvas(imageObject);
            }

            function switchTab(imageId) {
                if (appState.activeTool) toggleTool(appState.activeTool);
                appState.activeImageId = imageId;
                render();
            }

            function closeTab(imageId) {
                const imageIndex = appState.images.findIndex(img => img.id === imageId);
                if (imageIndex > -1) appState.images.splice(imageIndex, 1)[0].canvas.remove();
                if (appState.activeImageId === imageId) {
                    appState.activeImageId = appState.images.length > 0 ? appState.images[appState.images.length - 1].id : null;
                }
                render();
            }

            function redrawActiveCanvas() {
                const activeImage = getActiveImage();
                if (activeImage) redrawCanvas(activeImage);
            }

            function resetActiveImage() {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                activeImage.filters = getDefaultFilters();
                activeImage.focus = { path: [], blur: 5 };
                activeImage.colorSelect = { color: null, tolerance: 30 };
                activeImage.currentElement = activeImage.originalElement;
                if (appState.activeTool) toggleTool(appState.activeTool);
                updateCanvas(activeImage);
                render();
            }

            function downloadActiveImage() {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = activeImage.canvas.width;
                exportCanvas.height = activeImage.canvas.height;
                drawCanvasContent(activeImage, exportCanvas.getContext('2d'), true);
                const link = document.createElement('a');
                link.download = `redigerad-${activeImage.name}`;
                link.href = exportCanvas.toDataURL('image/png');
                link.click();
            }

            function getActiveImage() {
                return appState.images.find(img => img.id === appState.activeImageId) || null;
            }
            
            function getDefaultFilters() {
                return { brightness: 100, contrast: 100, saturate: 100, grayscale: 0, sepia: 0 };
            }

            // ---- RITNINGSFUNKTIONER ----

            function drawCanvasContent(imageObject, ctx, forExport = false) {
                if (!imageObject || !ctx) return;
                const img = imageObject.currentElement;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                if (imageObject.colorSelect.color && (forExport || appState.activeTool !== 'color-select')) {
                    drawColorSelect(ctx, imageObject, imageObject.colorSelect.tolerance, forExport);
                } else if (imageObject.focus.path.length > 2 && (forExport || appState.activeTool !== 'focus')) {
                    drawFocus(ctx, imageObject, imageObject.focus.blur);
                } else {
                    ctx.filter = buildFilterString(imageObject.filters);
                    ctx.drawImage(img, 0, 0);
                }
            }

            function redrawCanvas(imageObject) {
                const ctx = imageObject.canvas.getContext('2d');
                
                if (appState.activeTool === 'focus' && imageObject.focus.path.length > 1) {
                    drawFocusPreview(ctx, imageObject);
                } else if (appState.activeTool === 'color-select' && imageObject.colorSelect.color) {
                    drawColorSelect(ctx, imageObject, colorToleranceSlider.valueAsNumber);
                } else {
                    drawCanvasContent(imageObject, ctx);
                }
                
                if (appState.activeTool === 'crop' && appState.cropBox) drawCropBox(ctx);
                if (appState.activeTool === 'lasso' && appState.lassoPath.length > 0) drawLassoPath(ctx);
                if (appState.activeTool === 'pasting' && appState.pastedItem) drawPastedItem(ctx);
            }
            
            function buildFilterString(filters) {
                return `brightness(${filters.brightness}%) contrast(${filters.contrast}%) saturate(${filters.saturate}%) grayscale(${filters.grayscale}%) sepia(${filters.sepia}%)`;
            }
            
            // ---- VERKTYGSHANTERING ----

            function updateFiltersFromUI() {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                activeImage.filters.brightness = document.getElementById('brightness').valueAsNumber + 100;
                activeImage.filters.contrast = document.getElementById('contrast').valueAsNumber + 100;
                activeImage.filters.saturate = document.getElementById('saturate').valueAsNumber;
                activeImage.filters.grayscale = document.getElementById('grayscale').valueAsNumber;
                activeImage.filters.sepia = document.getElementById('sepia').valueAsNumber;
            }

            function toggleTool(toolName) {
                const currentlyActive = appState.activeTool === toolName;
                
                if (appState.activeTool) {
                    const btn = document.getElementById(`${appState.activeTool}-tool-btn`);
                    if(btn) btn.classList.remove('active');
                    const controls = document.getElementById(`${appState.activeTool}-controls`);
                    if(controls) controls.classList.add('hidden');
                    workspace.classList.remove('cropping', 'lassoing', 'focusing', 'pasting', 'color-selecting');
                    appState.cropBox = null;
                    appState.lassoPath = [];
                    appState.isDrawingFocus = false;
                    appState.pastedItem = null;
                    const activeImage = getActiveImage();
                    if(activeImage) {
                        activeImage.focus.path = [];
                        activeImage.colorSelect.color = null;
                    }
                }
                
                appState.activeTool = null;
                
                if (!currentlyActive) {
                    appState.activeTool = toolName;
                    const btn = document.getElementById(`${toolName}-tool-btn`);
                    if(btn) btn.classList.add('active');
                    const controls = document.getElementById(`${toolName}-controls`);
                    if(controls) {
                        controls.classList.remove('hidden');
                        if(toolName === 'lasso' || (toolName === 'focus' && !appState.isDrawingFocus) || (toolName === 'color-select' && !getActiveImage()?.colorSelect.color)) {
                            controls.classList.add('hidden');
                        }
                        if(toolName === 'focus' || toolName === 'color-select') controls.classList.remove('hidden');
                    }
                    workspace.classList.add(`${toolName}ing`);
                }
                redrawActiveCanvas();
            }
            
            function getMousePos(canvas, evt) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return { x: (evt.clientX - rect.left) * scaleX, y: (evt.clientY - rect.top) * scaleY };
            }
            
            // ---- ARBETSYTA HÄNDELSER ----

            function handleWorkspaceMouseDown(e) {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                const pos = getMousePos(activeImage.canvas, e);

                if (appState.activeTool === 'crop') {
                    appState.isCropping = true;
                    appState.cropBox = { startX: pos.x, startY: pos.y, endX: pos.x, endY: pos.y };
                } else if (appState.activeTool === 'lasso') {
                    appState.isDrawingLasso = true;
                    appState.lassoPath = [pos];
                } else if (appState.activeTool === 'focus') {
                    appState.isDrawingFocus = true;
                    activeImage.focus.path = [pos];
                }
            }

            function handleWorkspaceMouseMove(e) {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                const pos = getMousePos(activeImage.canvas, e);

                if (appState.isCropping && appState.cropBox) appState.cropBox.endX = pos.x;
                else if (appState.isDrawingLasso) appState.lassoPath.push(pos);
                else if (appState.isDrawingFocus) activeImage.focus.path.push(pos);
                else if (appState.activeTool === 'pasting' && appState.pastedItem) {
                    appState.pastedItem.x = pos.x - appState.pastedItem.image.width / 2;
                    appState.pastedItem.y = pos.y - appState.pastedItem.image.height / 2;
                }
                redrawActiveCanvas();
            }
            
            function handleWorkspaceMouseUp(e) {
                if (appState.isCropping) appState.isCropping = false;
                if (appState.isDrawingLasso) {
                    appState.isDrawingLasso = false;
                    if(appState.lassoPath.length > 2) lassoControls.classList.remove('hidden');
                }
                if (appState.isDrawingFocus) {
                    appState.isDrawingFocus = false;
                    if(getActiveImage().focus.path.length > 2) focusActions.style.display = 'grid';
                    redrawActiveCanvas();
                }
            }

            function handleWorkspaceClick(e) {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                const pos = getMousePos(activeImage.canvas, e);

                if (appState.activeTool === 'pasting' && appState.pastedItem) {
                    stampPastedItem();
                } else if (appState.activeTool === 'color-select') {
                    const ctx = activeImage.canvas.getContext('2d');
                    const pixel = ctx.getImageData(pos.x, pos.y, 1, 1).data;
                    activeImage.colorSelect.color = [pixel[0], pixel[1], pixel[2]];
                    selectedColorPreview.style.backgroundColor = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
                    colorSelectActions.style.display = 'grid';
                    redrawActiveCanvas();
                }
            }
            
            // ---- BESKÄRNING ----
            function drawCropBox(ctx) {
                const box = appState.cropBox;
                if (!box) return;
                const x = Math.min(box.startX, box.endX), y = Math.min(box.startY, box.endY);
                const width = Math.abs(box.startX - box.endX), height = Math.abs(box.startY - box.endY);
                ctx.save();
                ctx.beginPath();
                ctx.rect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.rect(x, y, width, height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                ctx.fill('evenodd');
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
                ctx.restore();
            }

            function applyCrop() {
                const activeImage = getActiveImage();
                const box = appState.cropBox;
                if (!activeImage || !box) return;
                const x = Math.min(box.startX, box.endX), y = Math.min(box.startY, box.endY);
                const width = Math.abs(box.startX - box.endX), height = Math.abs(box.startY - box.endY);
                if (width < 1 || height < 1) { toggleTool('crop'); return; }
                drawCanvasContent(activeImage, activeImage.canvas.getContext('2d'));
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width; tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(activeImage.canvas, x, y, width, height, 0, 0, width, height);
                const newImageElement = new Image();
                newImageElement.onload = () => {
                    activeImage.currentElement = newImageElement;
                    activeImage.focus.path = [];
                    activeImage.colorSelect.color = null;
                    toggleTool('crop');
                    updateCanvas(activeImage);
                    render();
                };
                newImageElement.src = tempCanvas.toDataURL();
            }

            // ---- FOKUS ----
            function drawFocus(ctx, imageObject, blurAmount) {
                ctx.save();
                ctx.filter = `blur(${blurAmount}px) ${buildFilterString(imageObject.filters)}`;
                ctx.drawImage(imageObject.currentElement, 0, 0);
                ctx.restore();
                ctx.save();
                const path2D = createPath2D(imageObject.focus.path);
                ctx.clip(path2D);
                ctx.filter = buildFilterString(imageObject.filters);
                ctx.drawImage(imageObject.currentElement, 0, 0);
                ctx.restore();
            }

            function drawFocusPreview(ctx, imageObject) {
                if (!imageObject || imageObject.focus.path.length < 2) return;
                drawFocus(ctx, imageObject, focusBlurSlider.valueAsNumber);
                drawPathOutline(ctx, imageObject.focus.path, !appState.isDrawingFocus);
            }
            
            function applyFocus() {
                const activeImage = getActiveImage();
                if (!activeImage || activeImage.focus.path.length < 3) return;
                activeImage.focus.blur = focusBlurSlider.valueAsNumber;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = activeImage.canvas.width;
                tempCanvas.height = activeImage.canvas.height;
                drawCanvasContent(activeImage, tempCanvas.getContext('2d'), true);
                const newImageElement = new Image();
                newImageElement.onload = () => {
                    activeImage.currentElement = newImageElement;
                    cancelFocus();
                };
                newImageElement.src = tempCanvas.toDataURL();
            }

            function cancelFocus() {
                const activeImage = getActiveImage();
                if (activeImage) activeImage.focus.path = [];
                appState.isDrawingFocus = false;
                focusActions.style.display = 'none';
                redrawActiveCanvas();
            }

            // ---- FÄRGVAL ----
            function drawColorSelect(ctx, imageObject, tolerance, forExport = false) {
                const img = imageObject.currentElement;
                const originalCanvas = document.createElement('canvas');
                originalCanvas.width = img.width;
                originalCanvas.height = img.height;
                const originalCtx = originalCanvas.getContext('2d');
                originalCtx.filter = buildFilterString(imageObject.filters);
                originalCtx.drawImage(img, 0, 0);

                const imageData = originalCtx.getImageData(0, 0, img.width, img.height);
                const data = imageData.data;
                const [targetR, targetG, targetB] = imageObject.colorSelect.color;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    const distance = Math.sqrt(Math.pow(r - targetR, 2) + Math.pow(g - targetG, 2) + Math.pow(b - targetB, 2));
                    if (distance > tolerance) {
                        const gray = r * 0.299 + g * 0.587 + b * 0.114;
                        data[i] = data[i+1] = data[i+2] = gray;
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            }

            function applyColorSelect() {
                const activeImage = getActiveImage();
                if (!activeImage || !activeImage.colorSelect.color) return;
                activeImage.colorSelect.tolerance = colorToleranceSlider.valueAsNumber;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = activeImage.canvas.width;
                tempCanvas.height = activeImage.canvas.height;
                drawCanvasContent(activeImage, tempCanvas.getContext('2d'), true);
                const newImageElement = new Image();
                newImageElement.onload = () => {
                    activeImage.currentElement = newImageElement;
                    cancelColorSelect();
                };
                newImageElement.src = tempCanvas.toDataURL();
            }

            function cancelColorSelect() {
                const activeImage = getActiveImage();
                if (activeImage) activeImage.colorSelect.color = null;
                colorSelectActions.style.display = 'none';
                selectedColorPreview.style.backgroundColor = '#1f2937';
                redrawActiveCanvas();
            }


            // ---- LASSO & URKLIPP ----
            function drawLassoPath(ctx) {
                drawPathOutline(ctx, appState.lassoPath, !appState.isDrawingLasso);
            }

            function handleLassoSelection(isCut) {
                const activeImage = getActiveImage();
                const path = appState.lassoPath;
                if (!activeImage || path.length < 3) return;
                const path2D = createPath2D(path);
                const bounds = getPathBounds(path);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = bounds.width; tempCanvas.height = bounds.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.translate(-bounds.x, -bounds.y);
                tempCtx.clip(path2D);
                drawCanvasContent(activeImage, tempCtx);
                const clippedImage = new Image();
                clippedImage.onload = () => {
                    appState.clipboard = { image: clippedImage, path: path2D };
                    pasteBtn.disabled = false;
                    lucide.createIcons();
                    if (isCut) {
                        const mainCtx = activeImage.canvas.getContext('2d');
                        mainCtx.save();
                        mainCtx.globalCompositeOperation = 'destination-out';
                        mainCtx.fill(path2D);
                        mainCtx.restore();
                        const newImageElement = new Image();
                        newImageElement.onload = () => {
                            activeImage.currentElement = newImageElement;
                            toggleTool('lasso');
                        };
                        newImageElement.src = activeImage.canvas.toDataURL();
                    } else {
                       toggleTool('lasso');
                    }
                };
                clippedImage.src = tempCanvas.toDataURL();
            }
            
            function enterPastingMode() {
                if (!appState.clipboard) return;
                toggleTool('pasting');
                appState.pastedItem = { image: appState.clipboard.image, x: -1000, y: -1000 };
            }

            function drawPastedItem(ctx) {
                if (!appState.pastedItem) return;
                ctx.save();
                ctx.globalAlpha = 0.75;
                ctx.drawImage(appState.pastedItem.image, appState.pastedItem.x, appState.pastedItem.y);
                ctx.restore();
            }

            function stampPastedItem() {
                const activeImage = getActiveImage();
                if (!activeImage || !appState.pastedItem) return;
                const ctx = activeImage.canvas.getContext('2d');
                ctx.drawImage(appState.pastedItem.image, appState.pastedItem.x, appState.pastedItem.y);
                const newImageElement = new Image();
                newImageElement.onload = () => {
                    activeImage.currentElement = newImageElement;
                    toggleTool('pasting');
                };
                newImageElement.src = activeImage.canvas.toDataURL();
            }

            // ---- HJÄLPFUNKTIONER ----
            function createPath2D(path) {
                const path2D = new Path2D();
                if (path.length < 2) return path2D;
                path2D.moveTo(path[0].x, path[0].y);
                for(let i = 1; i < path.length; i++) path2D.lineTo(path[i].x, path[i].y);
                path2D.closePath();
                return path2D;
            }

            function drawPathOutline(ctx, path, isClosed) {
                if (path.length < 2) return;
                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(path[0].x, path[0].y);
                for (let i = 1; i < path.length; i++) ctx.lineTo(path[i].x, path[i].y);
                if (isClosed) ctx.closePath();
                ctx.stroke();
                ctx.restore();
            }
            
            function getPathBounds(path) {
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                path.forEach(p => {
                    minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
                    maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
                });
                return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };
            }

            // ---- RENDERINGSFUNKTIONER ----

            function updateFilterControls() {
                const activeImage = getActiveImage();
                if (!activeImage) return;
                const f = activeImage.filters;
                document.getElementById('brightness').value = f.brightness - 100;
                document.getElementById('contrast').value = f.contrast - 100;
                document.getElementById('saturate').value = f.saturate;
                document.getElementById('grayscale').value = f.grayscale;
                document.getElementById('sepia').value = f.sepia;
                focusBlurSlider.value = activeImage.focus.blur;
                colorToleranceSlider.value = activeImage.colorSelect.tolerance;
            }
            
            function render() {
                const activeImage = getActiveImage();
                // Flikar
                tabsContainer.innerHTML = '';
                appState.images.forEach(img => {
                    const tab = document.createElement('div');
                    tab.className = `tab flex items-center gap-2 px-4 py-2 cursor-pointer border-b-2 border-transparent text-sm font-medium transition-colors duration-200 hover:bg-gray-700`;
                    tab.dataset.imageId = img.id;
                    if (img.id === appState.activeImageId) tab.classList.add('active', 'text-white');
                    else tab.classList.add('text-gray-400');
                    
                    const tabName = document.createElement('span');
                    tabName.textContent = img.name.length > 15 ? `${img.name.substring(0, 12)}...` : img.name;
                    tabName.title = img.name;

                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-gray-500 hover:text-white"></i>';
                    closeBtn.className = "p-1 rounded-full hover:bg-gray-600";
                    
                    tab.append(tabName, closeBtn);
                    tab.addEventListener('click', (e) => { if (e.target.closest('button') !== closeBtn) switchTab(img.id); });
                    closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeTab(img.id); });
                    tabsContainer.appendChild(tab);
                });
                lucide.createIcons();

                // Arbetsyta
                workspace.querySelectorAll('canvas').forEach(c => c.classList.add('hidden'));
                if (activeImage && activeImage.canvas) {
                    activeImage.canvas.classList.remove('hidden');
                    welcomeMessage.classList.add('hidden');
                } else if (appState.images.length === 0) {
                    welcomeMessage.classList.remove('hidden');
                }

                // Sidopanel
                if (activeImage) {
                    noImageMessage.classList.add('hidden');
                    toolsContainer.classList.remove('hidden');
                    toolsContainer.classList.add('flex');
                    updateFilterControls();
                    redrawActiveCanvas();
                } else {
                    noImageMessage.classList.remove('hidden');
                    toolsContainer.classList.add('hidden');
                    toolsContainer.classList.remove('flex');
                }
            }
        });
    </script>
</body>
</html>
